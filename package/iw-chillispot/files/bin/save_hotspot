#!/bin/sh
# HotSpot add-on module to webif^2 v1.0
# by Liran Tal <liran@enginx.com>
#
# this module is part of the webif^2 interface for the x-wrt.
# thanks to thepeople and nbd for their help to understand the webif

. /etc/functions.sh

config_cb() {
	local cfgtype="$1"
	local name="$2"
	[ "$cfgtype" = "chilli" ] && chilli_cfg="$name" || unset chilli_cfg
}

option_cb() {
	local varname="$1"; shift
	local value="$*"
	[ -n "$chilli_cfg" ] && [ -n "$value" ] && {
		case "$varname" in
			debug|macauth|uamanydns|coanoipcheck|acctupdate|fg|eapolenable)
				case "$value" in
					1|on|enabled) chilli_options="$chilli_options${varname}${_lf}" ;;
				esac
			;;
			*) chilli_options="$chilli_options${varname} ${value}${_lf}" ;;
		esac
	}
}

_lf="
"
echo "#!/bin/sh /etc/rc.common
# Copyright (C) 2006 OpenWrt.org
START=50

RUN_D=/var/run
PID_F=$RUN_D/chilli.pid

start() {
	/usr/sbin/chilli 
	/etc/init.d/firewall restart
}

stop() {
	[ -f $PID_F ] && kill $(cat $PID_F) >/dev/null 2>&1
}
" > /etc/init.d/chilli
chilli_config="/etc/chilli.conf"
chilli_options="# this file is automatically generated${_lf}"
config_load hotspot
echo "$chilli_options" > "$chilli_config"
